{"version":3,"sources":["../src/index.ts"],"sourcesContent":["import fs from \"fs\";\nimport path from \"path\";\nimport type { Configuration, RuleSetRule, RuleSetUseItem } from \"webpack\";\n\nexport interface DocusaurusContext {\n  baseUrl: string;\n  siteDir: string;\n  generatedFilesDir: string;\n  i18n: {\n    currentLocale: string;\n  };\n}\n\nexport interface WebpackRule extends RuleSetRule {\n  oneOf?: RuleSetRule[];\n  use?: RuleSetUseItem[] | RuleSetUseItem;\n}\n\nexport interface ConfigureWebpackUtils {\n  getStyleLoaders: (...args: any[]) => any[];\n  getCacheLoader: (...args: any[]) => any;\n  getBabelLoader: (...args: any[]) => any;\n}\n\nexport interface TerminologyOptions {\n  termsDir: string;\n  glossaryFilepath: string;\n  baseUrl?: string;\n  resolved?: boolean;\n  glossaryTerms?: Record<string, any>;\n  termPreviewComponentPath?: string;\n  glossaryComponentPath?: string;\n  glossaryDir?: string;\n}\n\nexport default async function DocusaurusTerminologyPlugin(\n  context: DocusaurusContext,\n  options: TerminologyOptions,\n) {\n  const unixFormattedTermsPath = options.termsDir\n    .replace(/^\\.\\//, \"\")\n    .replace(/[.*+?^${}()|[\\]\\\\]/g, \"\\\\$&\");\n\n  const winFormattedTermsPath = options.termsDir\n    .replace(/\\//g, \"\\\\\")\n    .replace(/\\./, \"\")\n    .replace(/[*+?^${}()|[\\]\\\\]/g, \"\\\\$&\");\n\n  const termsPath =\n    process.platform === \"win32\"\n      ? winFormattedTermsPath\n      : unixFormattedTermsPath;\n\n  const termsRegex = new RegExp(`${termsPath}.*?\\.mdx?$`);\n\n  const unixFormattedGlossaryPath = options.glossaryFilepath\n    .replace(/^\\.\\//, \"\")\n    .replace(/[.*+?^${}()|[\\]\\\\]/g, \"\\\\$&\");\n\n  const winFormattedGlossaryPath = options.glossaryFilepath\n    .replace(/\\//g, \"\\\\\")\n    .replace(/\\./, \"\")\n    .replace(/[*+?^${}()|[\\]\\\\]/g, \"\\\\$&\");\n\n  const glossaryPath =\n    process.platform === \"win32\"\n      ? winFormattedGlossaryPath\n      : unixFormattedGlossaryPath;\n\n  const glossaryRegex = new RegExp(`${glossaryPath}`);\n\n  try {\n    fs.rm(\"node_modules/.cache\", { recursive: true }, (err) => {\n      if (err) {\n        console.error(err);\n      }\n    });\n  } catch (err) {}\n\n  return {\n    name: \"terminology-docusaurus-plugin\",\n    configureWebpack(\n      config: Configuration,\n      isServer: boolean,\n      utils: ConfigureWebpackUtils,\n    ) {\n      options.baseUrl = config.output?.publicPath as string;\n\n      if (!options.resolved) {\n        for (const term in options.glossaryTerms) {\n          options.glossaryTerms[`${config.output?.publicPath}${term}`] =\n            options.glossaryTerms[term];\n          delete options.glossaryTerms[term];\n        }\n      }\n      options.resolved = true;\n\n      let rule = (config.module?.rules as WebpackRule[]).find((rule) => {\n        return (\n          rule.use &&\n          Array.isArray(rule.use) &&\n          rule.use.some(\n            (kider: RuleSetUseItem) =>\n              typeof kider === \"object\" &&\n              typeof kider.loader === \"string\" &&\n              kider.loader.includes(\"plugin-content-docs\"),\n          )\n        );\n      });\n\n      if (!rule) {\n        rule = (config.module?.rules as WebpackRule[]).find((rule) => {\n          return (\n            rule.use &&\n            Array.isArray(rule.use) &&\n            rule.use.some(\n              (kider: RuleSetUseItem) =>\n                typeof kider === \"object\" &&\n                typeof kider.loader === \"string\" &&\n                kider.loader.includes(\"mdx-loader\"),\n            )\n          );\n        });\n      }\n\n      if (!rule) {\n        rule = (config.module?.rules as WebpackRule[]).find((rule) => {\n          if (!rule.test) return false;\n          const ruleRegExp = new RegExp(rule.test as string);\n          return ruleRegExp.test(\"test.md\") && ruleRegExp.test(\"test.mdx\");\n        });\n      }\n\n      if (rule && Array.isArray(rule.use)) {\n        rule.oneOf = [\n          {\n            test: termsRegex,\n            enforce: \"pre\",\n            use: [\n              {\n                loader: require.resolve(\"heliannuuthus-webpack-terms-loader\"),\n                options,\n              },\n            ],\n          },\n          {\n            test: glossaryRegex,\n            enforce: \"pre\",\n            use: [\n              {\n                loader: require.resolve(\n                  \"heliannuuthus-webpack-glossary-loader\",\n                ),\n                options,\n              },\n            ],\n          },\n        ];\n\n        rule.use.push({\n          loader: require.resolve(\"heliannuuthus-webpack-terms-replace-loader\"),\n          options,\n        });\n      }\n\n      return {\n        mergeStrategy: { module: \"replace\" },\n        module: config.module,\n      };\n    },\n  };\n}\n"],"mappings":";;;;;;;;AAAA,OAAO,QAAQ;AAmCf,eAAO,4BACL,SACA,SACA;AACA,QAAM,yBAAyB,QAAQ,SACpC,QAAQ,SAAS,EAAE,EACnB,QAAQ,uBAAuB,MAAM;AAExC,QAAM,wBAAwB,QAAQ,SACnC,QAAQ,OAAO,IAAI,EACnB,QAAQ,MAAM,EAAE,EAChB,QAAQ,sBAAsB,MAAM;AAEvC,QAAM,YACJ,QAAQ,aAAa,UACjB,wBACA;AAEN,QAAM,aAAa,IAAI,OAAO,GAAG,SAAS,WAAY;AAEtD,QAAM,4BAA4B,QAAQ,iBACvC,QAAQ,SAAS,EAAE,EACnB,QAAQ,uBAAuB,MAAM;AAExC,QAAM,2BAA2B,QAAQ,iBACtC,QAAQ,OAAO,IAAI,EACnB,QAAQ,MAAM,EAAE,EAChB,QAAQ,sBAAsB,MAAM;AAEvC,QAAM,eACJ,QAAQ,aAAa,UACjB,2BACA;AAEN,QAAM,gBAAgB,IAAI,OAAO,GAAG,YAAY,EAAE;AAElD,MAAI;AACF,OAAG,GAAG,uBAAuB,EAAE,WAAW,KAAK,GAAG,CAAC,QAAQ;AACzD,UAAI,KAAK;AACP,gBAAQ,MAAM,GAAG;AAAA,MACnB;AAAA,IACF,CAAC;AAAA,EACH,SAAS,KAAK;AAAA,EAAC;AAEf,SAAO;AAAA,IACL,MAAM;AAAA,IACN,iBACE,QACA,UACA,OACA;AACA,cAAQ,UAAU,OAAO,QAAQ;AAEjC,UAAI,CAAC,QAAQ,UAAU;AACrB,mBAAW,QAAQ,QAAQ,eAAe;AACxC,kBAAQ,cAAc,GAAG,OAAO,QAAQ,UAAU,GAAG,IAAI,EAAE,IACzD,QAAQ,cAAc,IAAI;AAC5B,iBAAO,QAAQ,cAAc,IAAI;AAAA,QACnC;AAAA,MACF;AACA,cAAQ,WAAW;AAEnB,UAAI,QAAQ,OAAO,QAAQ,OAAwB,KAAK,CAACA,UAAS;AAChE,eACEA,MAAK,OACL,MAAM,QAAQA,MAAK,GAAG,KACtBA,MAAK,IAAI;AAAA,UACP,CAAC,UACC,OAAO,UAAU,YACjB,OAAO,MAAM,WAAW,YACxB,MAAM,OAAO,SAAS,qBAAqB;AAAA,QAC/C;AAAA,MAEJ,CAAC;AAED,UAAI,CAAC,MAAM;AACT,gBAAQ,OAAO,QAAQ,OAAwB,KAAK,CAACA,UAAS;AAC5D,iBACEA,MAAK,OACL,MAAM,QAAQA,MAAK,GAAG,KACtBA,MAAK,IAAI;AAAA,YACP,CAAC,UACC,OAAO,UAAU,YACjB,OAAO,MAAM,WAAW,YACxB,MAAM,OAAO,SAAS,YAAY;AAAA,UACtC;AAAA,QAEJ,CAAC;AAAA,MACH;AAEA,UAAI,CAAC,MAAM;AACT,gBAAQ,OAAO,QAAQ,OAAwB,KAAK,CAACA,UAAS;AAC5D,cAAI,CAACA,MAAK,KAAM,QAAO;AACvB,gBAAM,aAAa,IAAI,OAAOA,MAAK,IAAc;AACjD,iBAAO,WAAW,KAAK,SAAS,KAAK,WAAW,KAAK,UAAU;AAAA,QACjE,CAAC;AAAA,MACH;AAEA,UAAI,QAAQ,MAAM,QAAQ,KAAK,GAAG,GAAG;AACnC,aAAK,QAAQ;AAAA,UACX;AAAA,YACE,MAAM;AAAA,YACN,SAAS;AAAA,YACT,KAAK;AAAA,cACH;AAAA,gBACE,QAAQ,UAAQ,QAAQ,oCAAoC;AAAA,gBAC5D;AAAA,cACF;AAAA,YACF;AAAA,UACF;AAAA,UACA;AAAA,YACE,MAAM;AAAA,YACN,SAAS;AAAA,YACT,KAAK;AAAA,cACH;AAAA,gBACE,QAAQ,UAAQ;AAAA,kBACd;AAAA,gBACF;AAAA,gBACA;AAAA,cACF;AAAA,YACF;AAAA,UACF;AAAA,QACF;AAEA,aAAK,IAAI,KAAK;AAAA,UACZ,QAAQ,UAAQ,QAAQ,4CAA4C;AAAA,UACpE;AAAA,QACF,CAAC;AAAA,MACH;AAEA,aAAO;AAAA,QACL,eAAe,EAAE,QAAQ,UAAU;AAAA,QACnC,QAAQ,OAAO;AAAA,MACjB;AAAA,IACF;AAAA,EACF;AACF;","names":["rule"]}